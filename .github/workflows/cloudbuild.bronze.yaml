# .github/workflows/cloudbuild.bronze.yaml

# Variáveis que o Gatilho do Cloud Build irá substituir:
# _PROJECT_ID: etl-hoteis
# _GCS_TEMPLATE_BUCKET: bk-etl-hotelaria
# _LOCATION: southamerica-east1
# COMMIT_SHA (Variável embutida do Cloud Build)

steps:
  # ----------------------------------------------------------------------
  # PASSO 1: Instalação de Dependências e Testes de Unidade
  # ----------------------------------------------------------------------
  - id: 'Rodar Testes da Camada Bronze'
    name: 'python:3.10' # Usando Python 3.10 para evitar erros de compilação do 3.9
    entrypoint: bash
    args:
      - -c
      - |
        echo "Instalando dependências de build e teste..."
        
        # 1. Instala dependências (requirements.txt está em src/bronze)
        pip install -r requirements.txt
        
        # 2. Instala o projeto (o diretório que contém o setup.py)
        pip install -e .
        
        echo "Executando testes..."
        # 3. Executa os testes (caminho completo)
        python -m pytest tests/test_transforms_bronze.py
        
    dir: 'dataflow-pipelines' # Executa a partir da raiz do repositório, usando os caminhos longos acima.

  # ----------------------------------------------------------------------
  # PASSO 2: Build da Imagem Docker do Flex Template
  # ----------------------------------------------------------------------
  - id: 'Buildar Imagem Docker'
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/${_PROJECT_ID}/dataflow/bronze-hotelaria:$COMMIT_SHA'
      - '-f' 
      - 'dataflow-pipelines/src/bronze/Dockerfile' 
      - 'dataflow-pipelines' 
    dir: '.' 

  # ----------------------------------------------------------------------
  # PASSO 3: Push da Imagem para o GCR
  # ----------------------------------------------------------------------
  - id: 'Push da Imagem'
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/${_PROJECT_ID}/dataflow/bronze-hotelaria:$COMMIT_SHA'
    dir: 'dataflow-pipelines/src/bronze'

  # ----------------------------------------------------------------------
  # PASSO 4: Criar o Flex Template no GCS
  # ----------------------------------------------------------------------
  - id: 'Criar Flex Template'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - -c
      - |
        echo "Gerando o arquivo JSON do Flex Template..."
        # REMOÇÃO DO ARGUMENTO --region que causa o erro de sintaxe
        gcloud dataflow flex-template build gs://${_GCS_TEMPLATE_BUCKET}/templates/bronze-hotelaria.json \
          --image 'gcr.io/${_PROJECT_ID}/dataflow/bronze-hotelaria:$COMMIT_SHA' \
          --sdk-language 'PYTHON' \
          --metadata-file 'dataflow-pipelines/src/bronze/metadata.json' \
          --project '${_PROJECT_ID}'
          # A REGIÃO é definida na execução do template, não no build.
    dir: '.'

  # ----------------------------------------------------------------------
  # Passo 5: Executar o Job Dataflow (Deploy Automático)
  # ----------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Executar Job Bronze'
    entrypoint: 'bash'
    args:
      [
        '-c',
        'gcloud dataflow jobs run etl-bronze-$COMMIT_SHA \
        --template-file  "gs://bk-etl-hotelaria/templates/bronze-hotelaria.json" \
        --region "us-east1" \
        --project "etl-hoteis" \
        --parameters dataset="bronze_hotelaria",gcs_input_path="gs://bk-etl-hotelaria/transient/source_*/source_*.csv"',
      ]

options:
  logging: CLOUD_LOGGING_ONLY